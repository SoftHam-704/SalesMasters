CREATE OR REPLACE FUNCTION public.fn_upsert_preco(p_pro_id integer, p_industria integer, p_tabela character varying, p_precobruto double precision, p_precopromo double precision DEFAULT NULL::double precision, p_precoespecial double precision DEFAULT NULL::double precision, p_ipi double precision DEFAULT 0, p_st double precision DEFAULT 0, p_grupodesconto integer DEFAULT NULL::integer, p_descontoadd double precision DEFAULT 0, p_datatbela date DEFAULT CURRENT_DATE, p_datavencimento date DEFAULT NULL::date)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- UPSERT: insere ou atualiza
    INSERT INTO cad_tabelaspre (
        itab_idprod,
        itab_idindustria,
        itab_tabela,
        itab_precobruto,
        itab_precopromo,
        itab_precoespecial,
        itab_ipi,
        itab_st,
        itab_grupodesconto,
        itab_descontoadd,
        itab_datatabela,
        itab_datavencimento,
        itab_status
    ) VALUES (
        p_pro_id,
        p_industria,
        p_tabela,
        p_precobruto,
        p_precopromo,
        p_precoespecial,
        p_ipi,
        p_st,
        p_grupodesconto,
        p_descontoadd,
        p_datatbela,
        p_datavencimento,
        true
    )
    ON CONFLICT (itab_idprod, itab_tabela) 
    DO UPDATE SET
        itab_precobruto = EXCLUDED.itab_precobruto,
        itab_precopromo = EXCLUDED.itab_precopromo,
        itab_precoespecial = EXCLUDED.itab_precoespecial,
        itab_ipi = EXCLUDED.itab_ipi,
        itab_st = EXCLUDED.itab_st,
        itab_grupodesconto = EXCLUDED.itab_grupodesconto,
        itab_descontoadd = EXCLUDED.itab_descontoadd,
        itab_datatabela = EXCLUDED.itab_datatabela,
        itab_datavencimento = EXCLUDED.itab_datavencimento,
        itab_status = EXCLUDED.itab_status;
END;
$function$
